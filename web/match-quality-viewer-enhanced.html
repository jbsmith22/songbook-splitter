<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Songbook Match Quality Viewer - Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Left Column - Folder Tree */
        .left-panel {
            width: 35%;
            background: #252526;
            border-right: 1px solid #3e3e42;
            overflow-y: auto;
            padding: 20px;
        }

        /* Right Column - Details */
        .right-panel {
            width: 65%;
            background: #1e1e1e;
            overflow-y: auto;
            padding: 20px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #569cd6;
        }

        .summary {
            background: #2d2d30;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            border-left: 3px solid #569cd6;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .stat {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 3px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #858585;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            background: #0e639c;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #1177bb;
        }

        .btn-success {
            background: #4ec9b0;
            color: #000;
        }

        .btn-success:hover {
            background: #5ed9c0;
        }

        .btn-secondary {
            background: #3e3e42;
        }

        .btn-secondary:hover {
            background: #4e4e52;
        }

        /* Artist/Folder Groups */
        .artist-group {
            margin-bottom: 10px;
        }

        .artist-header {
            background: #2d2d30;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .artist-header:hover {
            background: #37373d;
        }

        .artist-header.expanded {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .artist-name {
            font-weight: bold;
            font-size: 14px;
        }

        .artist-count {
            font-size: 12px;
            color: #858585;
        }

        .folder-list {
            display: none;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-top: none;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        .folder-list.expanded {
            display: block;
        }

        .folder-item {
            padding: 8px 15px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .folder-item:hover {
            background: #2d2d30;
        }

        .folder-item.selected {
            background: #37373d;
        }

        .folder-item.marked-exact {
            border-left-color: #4ec9b0 !important;
            background: #2d3d30;
        }

        .folder-item.perfect { border-left-color: #4ec9b0; }
        .folder-item.excellent { border-left-color: #608b4e; }
        .folder-item.good { border-left-color: #569cd6; }
        .folder-item.fair { border-left-color: #dcdcaa; }
        .folder-item.weak { border-left-color: #ce9178; }
        .folder-item.poor { border-left-color: #f48771; }

        .folder-name {
            font-size: 13px;
            flex: 1;
        }

        .folder-badges {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .folder-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .badge-perfect { background: #4ec9b0; color: #000; }
        .badge-excellent { background: #608b4e; color: #fff; }
        .badge-good { background: #569cd6; color: #fff; }
        .badge-fair { background: #dcdcaa; color: #000; }
        .badge-weak { background: #ce9178; color: #000; }
        .badge-poor { background: #f48771; color: #000; }
        .badge-marked { background: #4ec9b0; color: #000; }

        /* Details Panel */
        .details-empty {
            text-align: center;
            padding: 60px 20px;
            color: #858585;
        }

        .details-content {
            display: none;
        }

        .details-content.active {
            display: block;
        }

        .details-header {
            background: #2d2d30;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .details-header-text {
            flex: 1;
        }

        .details-title {
            font-size: 20px;
            margin-bottom: 10px;
            color: #4ec9b0;
        }

        .details-subtitle {
            font-size: 14px;
            color: #858585;
        }

        .section {
            background: #252526;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 16px;
            margin-bottom: 10px;
            color: #569cd6;
            border-bottom: 1px solid #3e3e42;
            padding-bottom: 5px;
        }

        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .criteria-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .criteria-icon {
            font-size: 18px;
        }

        .criteria-label {
            font-size: 13px;
        }

        .check-yes { color: #4ec9b0; }
        .check-no { color: #f48771; }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #3e3e42;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #858585;
            font-size: 13px;
        }

        .info-value {
            font-size: 13px;
            font-weight: bold;
        }

        /* File Comparison Table */
        .file-comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .file-comparison-table th {
            background: #2d2d30;
            padding: 10px;
            text-align: left;
            font-size: 13px;
            border-bottom: 2px solid #3e3e42;
        }

        .file-comparison-table td {
            padding: 10px;
            font-size: 12px;
            border-bottom: 1px solid #3e3e42;
            vertical-align: top;
        }

        .file-comparison-table tr:hover {
            background: #2d2d30;
        }

        .file-name {
            font-family: 'Consolas', monospace;
            word-break: break-all;
        }

        .file-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }

        .status-match { background: #4ec9b0; color: #000; }
        .status-local-only { background: #ce9178; color: #000; }
        .status-s3-only { background: #569cd6; color: #fff; }
        .status-hash-mismatch { background: #f48771; color: #000; }

        .action-buttons-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .action-btn {
            padding: 4px 10px;
            font-size: 11px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .action-btn-copy-to-s3 {
            background: #569cd6;
            color: white;
        }

        .action-btn-copy-to-local {
            background: #608b4e;
            color: white;
        }

        .action-btn-delete {
            background: #ce9178;
            color: #000;
        }

        .action-btn-delete-both {
            background: #f48771;
            color: #000;
        }

        .action-btn.selected {
            outline: 2px solid #4ec9b0;
            outline-offset: 2px;
        }

        .legend {
            background: #2d2d30;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }

        .legend-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #569cd6;
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .legend-color {
            width: 20px;
            height: 3px;
        }

        .marked-banner {
            background: #4ec9b0;
            color: #000;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #3e3e42;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4e4e52;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel: Folder Tree -->
        <div class="left-panel">
            <h1>Match Quality Browser</h1>

            <div class="summary">
                <div style="font-weight: bold; margin-bottom: 10px;">Overall Statistics</div>
                <div class="summary-stats">
                    <div class="stat">
                        <div class="stat-value" id="total-count">0</div>
                        <div class="stat-label">Total Folders</div>
                    </div>

        <div class="filter-controls" style="background: #2d2d30; padding: 15px; margin-bottom: 20px; border-radius: 4px; border-left: 3px solid #569cd6;">
            <div style="font-weight: bold; margin-bottom: 10px; color: #569cd6;">Filter by Match Criteria:</div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="filter-exact-name" checked style="margin-right: 8px;">
                    <span>Exact Folder Name</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="filter-exact-count" checked style="margin-right: 8px;">
                    <span>Exact File Count</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="filter-has-manifest" checked style="margin-right: 8px;">
                    <span>Has Manifest</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="filter-all-artifacts" checked style="margin-right: 8px;">
                    <span>All Artifacts (5/5)</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="filter-files-match" checked style="margin-right: 8px;">
                    <span>All Files Match</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="filter-fuzzy-name" checked style="margin-right: 8px;">
                    <span>Fuzzy Name Match</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="filter-different-count" checked style="margin-right: 8px;">
                    <span>Different File Count</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="filter-no-manifest" checked style="margin-right: 8px;">
                    <span>No Manifest</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="filter-partial-artifacts" checked style="margin-right: 8px;">
                    <span>Partial/No Artifacts</span>
                </label>
            
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #3e3e42;">
                    <div style="color: #4ec9b0; margin-bottom: 8px; font-weight: bold;">Completed Filter:</div>
                    <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 5px;">
                        <input type="radio" name="completed-filter" value="all" checked onclick="applyFilters()" style="margin-right: 8px;">
                        <span>Show All</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 5px;">
                        <input type="radio" name="completed-filter" value="hide" onclick="applyFilters()" style="margin-right: 8px;">
                        <span>Hide Completed</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="completed-filter" value="only" onclick="applyFilters()" style="margin-right: 8px;">
                        <span>Show Only Completed</span>
                    </label>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <button class="btn" onclick="applyFilters()" style="background: #0e639c; padding: 8px 16px;">Apply Filters</button>
                <button class="btn" onclick="resetFilters()" style="background: #666; padding: 8px 16px; margin-left: 10px;">Reset</button>
                <button class="btn" onclick="markAllPerfectAsComplete()" style="background: #4ec9b0; color: #000; padding: 8px 16px; margin-left: 10px; font-weight: bold;">Mark All Perfect as Complete</button>
                <span id="filter-result-count" style="margin-left: 20px; color: #858585;"></span>
            </div>
        </div>

                    <div class="stat">
                        <div class="stat-value" id="marked-count" style="color: #4ec9b0;">0</div>
                        <div class="stat-label">Marked Exact</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="decisions-count" style="color: #569cd6;">0</div>
                        <div class="stat-label">With Decisions</div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="exportDecisions()">Export Decisions</button>
                <button class="btn btn-secondary" onclick="importDecisions()">Import</button>
                <button class="btn" onclick="clearAllDecisions()" style="background: #d32f2f; color: white; margin-left: 10px;">Clear All</button>
                <input type="file" id="import-file" style="display: none;" accept=".json" onchange="handleImport(event)">
            </div>

            <div class="legend">
                <div class="legend-title">Quality Tiers</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4ec9b0;"></div>
                        <span>Perfect / Marked</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #608b4e;"></div>
                        <span>Excellent</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #569cd6;"></div>
                        <span>Good</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #dcdcaa;"></div>
                        <span>Fair</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ce9178;"></div>
                        <span>Weak</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f48771;"></div>
                        <span>Poor</span>
                    </div>
                </div>
            </div>

            <div id="artist-list" style="margin-top: 20px;"></div>
        </div>

        <!-- Right Panel: Details -->
        <div class="right-panel">
            <div class="details-empty" id="empty-message">
                <h2>Select a folder to view details</h2>
                <p style="margin-top: 10px;">Click on any folder in the left panel to see its match quality analysis</p>
            </div>

            <div class="details-content" id="details-content">
                <div class="details-header">
                    <div class="details-header-text">
                        <div class="details-title" id="details-title"></div>
                        <div class="details-subtitle" id="details-subtitle"></div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" id="mark-complete-btn" onclick="toggleComplete(selectedFolder.local_path)" style="background: #4ec9b0; color: #000; font-weight: bold;">
                            <span id="complete-btn-text">Mark as Complete</span>
                        </button>
                    </div>
                </div>

                <div id="marked-banner" class="marked-banner" style="display: none;">
                    ✓ Marked as Exact Match
                </div>

                <div class="section">
                    <div class="section-title">Match Criteria</div>
                    <div class="criteria-grid" id="criteria-grid"></div>
                </div>

                <div class="section">
                    <div class="section-title">Folder Information</div>
                    <div id="folder-info"></div>
                </div>

                <div class="section">
                    <div class="section-title">File Comparison & Reconciliation</div>
                    <div id="file-comparison"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="match-quality-data.js"></script>
    <script>
// Data loaded from external file match-quality-data.js





        const STORAGE_KEY = 'songbook_reconciliation_decisions';
        let matchData = null;
        let selectedFolder = null;
        let decisions = loadDecisions();

        function loadDecisions() {
            // Pre-loaded rename decisions
            const embeddedDecisions = {};

            // Load from localStorage
            const stored = localStorage.getItem(STORAGE_KEY);
            let decisions = stored ? JSON.parse(stored) : {};

            // Merge embedded decisions (embedded takes precedence for file decisions)
            for (const [folderPath, folderData] of Object.entries(embeddedDecisions)) {
                if (!decisions[folderPath]) {
                    decisions[folderPath] = {};
                }
                if (!decisions[folderPath].fileDecisions) {
                    decisions[folderPath].fileDecisions = {};
                }
                // Merge file decisions from embedded data
                Object.assign(decisions[folderPath].fileDecisions, folderData.fileDecisions);
            }

            console.log('Loaded ' + Object.keys(embeddedDecisions).length + ' folders with pre-selected renames');
            return decisions;
        }


        function clearAllDecisions() {
            if (confirm('Clear all decisions? This cannot be undone.')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function saveDecisions() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(decisions));
            updateStatistics();
        }

        function updateStatistics() {
            const markedCount = Object.values(decisions).filter(d => d.markedExact).length;
            const decisionsCount = Object.values(decisions).filter(d => d.fileDecisions && Object.keys(d.fileDecisions).length > 0).length;

            document.getElementById('marked-count').textContent = markedCount;
            document.getElementById('decisions-count').textContent = decisionsCount;
        }

        function exportDecisions() {
            const exportData = {
                timestamp: new Date().toISOString(),
                version: '1.0',
                decisions: decisions,
                summary: {
                    total_folders: matchData.total_matches,
                    marked_exact: Object.values(decisions).filter(d => d.markedExact).length,
                    with_file_decisions: Object.values(decisions).filter(d => d.fileDecisions && Object.keys(d.fileDecisions).length > 0).length
                }
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reconciliation_decisions_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importDecisions() {
            document.getElementById('import-file').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    decisions = imported.decisions || {};
                    saveDecisions();
                    alert('Decisions imported successfully!');
                    initializeViewer();
                } catch (err) {
                    alert('Error importing file: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function toggleMarkAsExact() {
            if (!selectedFolder) return;

            const key = selectedFolder.local_path;
            if (!decisions[key]) {
                decisions[key] = {};
            }

            decisions[key].markedExact = !decisions[key].markedExact;
            saveDecisions();

            // Update UI
            document.getElementById('marked-banner').style.display = decisions[key].markedExact ? 'block' : 'none';
            document.getElementById('mark-exact-btn').textContent = decisions[key].markedExact ? 'Unmark as Exact' : 'Mark as Exact Match';

            // Update folder item in list
            const folderItems = document.querySelectorAll('.folder-item');
            folderItems.forEach(item => {
                if (item.dataset.path === key) {
                    if (decisions[key].markedExact) {
                        item.classList.add('marked-exact');
                        const badge = document.createElement('span');
                        badge.className = 'folder-badge badge-marked';
                        badge.textContent = '✓';
                        badge.dataset.marked = 'true';
                        item.querySelector('.folder-badges').appendChild(badge);
                    } else {
                        item.classList.remove('marked-exact');
                        const badge = item.querySelector('[data-marked="true"]');
                        if (badge) badge.remove();
                    }
                }
            });
        }

        function setFileAction(filename, action, status, filepath) {
            if (!selectedFolder) return;

            const key = selectedFolder.local_path;
            if (!decisions[key]) {
                decisions[key] = {};
            }
            if (!decisions[key].fileDecisions) {
                decisions[key].fileDecisions = {};
            }

            const decodedFilename = decodeURIComponent(filename);
            const decodedFilepath = decodeURIComponent(filepath);

            decisions[key].fileDecisions[decodedFilename] = {
                action: action,
                status: status,
                filepath: decodedFilepath,
                local_path: selectedFolder.local_path,
                s3_path: selectedFolder.s3_path,
                book_id: selectedFolder.book_id,
                timestamp: new Date().toISOString()
            };

            saveDecisions();

            // Refresh the display to show updated selections
            buildFileComparisonTable(selectedFolder);
        }

        function setFileRename(filename, normalizedName, location) {
            if (!selectedFolder) return;

            const key = selectedFolder.local_path;
            if (!decisions[key]) {
                decisions[key] = {};
            }
            if (!decisions[key].fileDecisions) {
                decisions[key].fileDecisions = {};
            }

            const decodedFilename = decodeURIComponent(filename);
            const decodedNormalizedName = decodeURIComponent(normalizedName);

            decisions[key].fileDecisions[decodedFilename] = {
                action: location === 'local' ? 'rename-local' : 'rename-s3',
                status: 'rename',
                filepath: decodedFilename,
                normalized_name: decodedNormalizedName,
                local_path: selectedFolder.local_path,
                s3_path: selectedFolder.s3_path,
                book_id: selectedFolder.book_id,
                timestamp: new Date().toISOString()
            };

            saveDecisions();
            buildFileComparisonTable(selectedFolder);
        }

        function acceptAllRenames(folderPath) {
            if (!selectedFolder || selectedFolder.local_path !== folderPath) return;

            const fc = selectedFolder.file_comparison || {};
            const folderArtist = extractFolderArtist(selectedFolder.local_path);

            // Build fileMap same way as in buildFileComparisonTable
            const fileMap = {};

            // Add local-only files
            (fc.local_only_files || []).forEach(item => {
                const filename = typeof item === 'string' ? item : item.filename;
                const normalizedName = normalizeFilename(filename, folderArtist);
                if (shouldNormalizeFilename(filename, normalizedName)) {
                    fileMap[filename] = { needsRenameLocal: true, normalizedLocal: normalizedName };
                }
            });

            // Add S3-only files
            (fc.s3_only_files || []).forEach(item => {
                const filename = typeof item === 'string' ? item : item.filename;
                const normalizedName = normalizeFilename(filename, folderArtist);
                if (shouldNormalizeFilename(filename, normalizedName)) {
                    fileMap[filename] = { ...(fileMap[filename] || {}), needsRenameS3: true, normalizedS3: normalizedName };
                }
            });

            // Add size mismatches
            (fc.size_mismatches || []).forEach(mismatch => {
                const normalizedName = normalizeFilename(mismatch.filename, folderArtist);
                const needsRename = shouldNormalizeFilename(mismatch.filename, normalizedName);
                if (needsRename) {
                    fileMap[mismatch.filename] = {
                        needsRenameLocal: needsRename,
                        needsRenameS3: needsRename,
                        normalizedLocal: normalizedName,
                        normalizedS3: normalizedName
                    };
                }
            });

            // Apply all renames
            let count = 0;
            for (const [filename, fileInfo] of Object.entries(fileMap)) {
                if (fileInfo.needsRenameLocal) {
                    setFileRename(encodeURIComponent(filename), encodeURIComponent(fileInfo.normalizedLocal), 'local');
                    count++;
                }
                if (fileInfo.needsRenameS3) {
                    setFileRename(encodeURIComponent(filename), encodeURIComponent(fileInfo.normalizedS3), 's3');
                    count++;
                }
            }

            if (count > 0) {
                alert(`Applied ${count} rename decision${count > 1 ? 's' : ''}`);
            }
        }

        function copyAllToS3(folderPath) {
            if (!selectedFolder || selectedFolder.local_path !== folderPath) return;

            const fc = selectedFolder.file_comparison || {};

            // Get all local-only files
            const localOnlyFiles = fc.local_only_files || [];

            let count = 0;
            localOnlyFiles.forEach(item => {
                const filename = typeof item === 'string' ? item : item.filename;
                setFileAction(encodeURIComponent(filename), 'copy-to-s3', 'local-only', encodeURIComponent(filename));
                count++;
            });

            if (count > 0) {
                // Refresh display
                displayFolderDetails(selectedFolder);
            }
        }

        function copyAllToLocal(folderPath) {
            if (!selectedFolder || selectedFolder.local_path !== folderPath) return;

            const fc = selectedFolder.file_comparison || {};

            // Get all S3-only files
            const s3OnlyFiles = fc.s3_only_files || [];

            let count = 0;
            s3OnlyFiles.forEach(item => {
                const filename = typeof item === 'string' ? item : item.filename;
                setFileAction(encodeURIComponent(filename), 'copy-to-local', 's3-only', encodeURIComponent(filename));
                count++;
            });

            if (count > 0) {
                // Refresh display
                displayFolderDetails(selectedFolder);
            }
        }

        function extractFolderArtist(folderPath) {
            // Extract artist from path like "Acdc/Acdc - Anthology" -> "Acdc"
            const parts = folderPath.split('/');
            return parts[0];
        }

        function normalizeFilename(filename, folderArtist) {
            // Remove .pdf extension
            let name = filename.replace(/\.pdf$/i, '');

            // Pattern: Artist - [Detailed Attribution] - Song Name
            // We want to extract just the song name and prepend folder artist

            // Split by " - "
            const parts = name.split(' - ');

            if (parts.length < 2) {
                // Already simple format or no hyphens
                return filename;
            }

            // First part should be the artist (might match folder artist)
            const firstPart = parts[0].trim();

            // If first part matches folder artist (case insensitive)
            if (firstPart.toLowerCase() === folderArtist.toLowerCase()) {
                // Check if there are more than 2 parts (indicating detailed attribution)
                if (parts.length > 2) {
                    // Take the last part as the song name
                    const songName = parts[parts.length - 1].trim();
                    return `${folderArtist} - ${songName}.pdf`;
                }
            } else {
                // First part doesn't match - might be "Various Artists" or wrong
                // Take the last part as song name
                const songName = parts[parts.length - 1].trim();
                return `${folderArtist} - ${songName}.pdf`;
            }

            // Already in correct format
            return filename;
        }

        function shouldNormalizeFilename(filename, normalizedName) {
            // Check if normalization would actually change the filename
            return filename !== normalizedName;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function escapeJsString(str) {
            if (!str) return '';
            return str
                .replace(/\\/g, '\\\\')   // backslash
                .replace(/'/g, "\\'")         // single quote
                .replace(/"/g, '\\"')         // double quote
                .replace(/\n/g, '\\n')       // newline
                .replace(/\r/g, '\\r')       // carriage return
                .replace(/\t/g, '\\t');      // tab
        }


        // Load data (embedded below) - use Promise to defer init until after variables are declared
        Promise.resolve(matchDataEmbedded).then(data => {
            matchData = data;
            console.log('Data loaded. matchData.total_matches:', matchData?.total_matches);
            console.log('Perfect folders count:', matchData?.quality_tiers?.perfect?.length);
            initializeViewer();
        });
        // Filtering state
        let currentFilters = {
            exactName: true,
            exactCount: true,
            hasManifest: true,
            allArtifacts: true,
            allFilesMatch: true,
            differentCount: true,
            noManifest: true,
            partialArtifacts: true,
            fuzzyName: true,
            completedFilter: 'all'
        };

        function applyFilters() {
            // Read checkbox states
            currentFilters = {
                exactName: document.getElementById('filter-exact-name').checked,
                exactCount: document.getElementById('filter-exact-count').checked,
                hasManifest: document.getElementById('filter-has-manifest').checked,
                allArtifacts: document.getElementById('filter-all-artifacts').checked,
                filesMatch: document.getElementById('filter-files-match').checked,
                fuzzyName: document.getElementById('filter-fuzzy-name').checked,
                differentCount: document.getElementById('filter-different-count').checked,
                noManifest: document.getElementById('filter-no-manifest').checked,
                partialArtifacts: document.getElementById('filter-partial-artifacts').checked,
                completedFilter: document.querySelector('input[name="completed-filter"]:checked')?.value || 'all'
            };

            // Re-render
            initializeViewer();
        }

        function resetFilters() {
            // Check all boxes
            document.getElementById('filter-exact-name').checked = true;
            document.getElementById('filter-exact-count').checked = true;
            document.getElementById('filter-has-manifest').checked = true;
            document.getElementById('filter-all-artifacts').checked = true;
            document.getElementById('filter-files-match').checked = true;
            document.getElementById('filter-fuzzy-name').checked = true;
            document.getElementById('filter-different-count').checked = true;
            document.getElementById('filter-no-manifest').checked = true;
            document.getElementById('filter-partial-artifacts').checked = true;
            
            // Reset completed filter to 'Show All'
            const showAllRadio = document.querySelector('input[name="completed-filter"][value="all"]');
            if (showAllRadio) showAllRadio.checked = true;

            applyFilters();
        }

        function folderMatchesFilters(folder) {
        // Check completed filter
        const isCompleted = decisions[folder.local_path]?.completed || false;
        if (currentFilters.completedFilter === 'hide' && isCompleted) {
            return false; // Hide completed folders
        }
        if (currentFilters.completedFilter === 'only' && !isCompleted) {
            return false; // Show only completed folders
        }

            const exactCount = folder.local_songs === folder.s3_songs;
            const exactName = folder.exact_alpha_name;
            const hasManifest = folder.has_manifest;
            const allArtifacts = folder.artifacts_count === 5;
            const allFilesMatch = folder.all_files_match;

            // Check if folder matches any of the enabled filter criteria (OR logic)
            let matches = false;

            if (currentFilters.exactName && exactName) matches = true;
            if (currentFilters.exactCount && exactCount) matches = true;
            if (currentFilters.hasManifest && hasManifest) matches = true;
            if (currentFilters.allArtifacts && allArtifacts) matches = true;
            if (currentFilters.filesMatch && allFilesMatch) matches = true;
            if (currentFilters.fuzzyName && !exactName) matches = true;
            if (currentFilters.differentCount && !exactCount) matches = true;
            if (currentFilters.noManifest && !hasManifest) matches = true;
            if (currentFilters.partialArtifacts && !allArtifacts) matches = true;

            return matches;
        }



        function initializeViewer() {
            updateStatistics();

            // Group folders by artist
            const artistGroups = {};

            for (const [tier, folders] of Object.entries(matchData.quality_tiers)) {
                const filteredFolders = folders.filter(folder => folderMatchesFilters(folder));
                for (const folder of filteredFolders) {
                    const artist = folder.local_path.split('/')[0];
                    if (!artistGroups[artist]) {
                        artistGroups[artist] = [];
                    }
                    artistGroups[artist].push({ ...folder, tier });
                }
            }

            const sortedArtists = Object.keys(artistGroups).sort();

            // Render artist groups
            const artistList = document.getElementById('artist-list');
            artistList.innerHTML = '';

            for (const artist of sortedArtists) {
                const folders = artistGroups[artist];
                const groupDiv = document.createElement('div');
                groupDiv.className = 'artist-group';

                const header = document.createElement('div');
                header.className = 'artist-header';
                header.innerHTML = `
                    <span class="artist-name">${artist}</span>
                    <span class="artist-count">${folders.length} folder${folders.length > 1 ? 's' : ''}</span>
                `;

                const folderList = document.createElement('div');
                folderList.className = 'folder-list';

                for (const folder of folders) {
                    const folderDiv = document.createElement('div');
                    folderDiv.className = `folder-item ${folder.tier}`;
                    folderDiv.dataset.path = folder.local_path;

                    const isCompleted = decisions[folder.local_path]?.completed;
                    if (isCompleted) {
                        folderDiv.classList.add('marked-complete');
                    }

                    const folderName = folder.local_path.split('/').slice(1).join('/') || artist;
                    folderDiv.innerHTML = `
                        <span class="folder-name">${folderName}</span>
                        <span class="folder-badges">
                            <span class="folder-badge badge-${folder.tier}">${folder.tier}</span>
                            ${isCompleted ? '<span class="folder-badge badge-marked" data-marked="true">✓</span>' : ''}
                        </span>
                    `;
                    folderDiv.onclick = () => showDetails(folder);
                    folderList.appendChild(folderDiv);
                }

                header.onclick = (e) => {
                    e.stopPropagation();
                    header.classList.toggle('expanded');
                    folderList.classList.toggle('expanded');
                };

                groupDiv.appendChild(header);
                groupDiv.appendChild(folderList);
                artistList.appendChild(groupDiv);
            }
        }

        function showDetails(folder) {
            selectedFolder = folder;

            // Update selected state
            document.querySelectorAll('.folder-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.folder-item').classList.add('selected');

            // Show details panel
            document.getElementById('empty-message').style.display = 'none';
            document.getElementById('details-content').classList.add('active');

            // Update title
            document.getElementById('details-title').textContent = folder.local_path;
            document.getElementById('details-subtitle').textContent = `Quality: ${folder.tier.toUpperCase()}`;

            // Check if marked
            // Check completion status and update button
            const isCompleted = decisions[folder.local_path]?.completed;
            const completeBtn = document.getElementById('mark-complete-btn');
            if (completeBtn) {
                const btnText = document.getElementById('complete-btn-text');
                if (btnText) btnText.textContent = isCompleted ? 'Unmark' : 'Mark as Complete';
            }

            // Update criteria
            const criteriaGrid = document.getElementById('criteria-grid');
            criteriaGrid.innerHTML = `
                <div class="criteria-item">
                    <span class="criteria-icon ${folder.exact_count ? 'check-yes' : 'check-no'}">${folder.exact_count ? '✓' : '✗'}</span>
                    <span class="criteria-label">Exact file count</span>
                </div>
                <div class="criteria-item">
                    <span class="criteria-icon ${folder.exact_alpha_name ? 'check-yes' : 'check-no'}">${folder.exact_alpha_name ? '✓' : '✗'}</span>
                    <span class="criteria-label">Exact folder name</span>
                </div>
                <div class="criteria-item">
                    <span class="criteria-icon ${folder.has_manifest ? 'check-yes' : 'check-no'}">${folder.has_manifest ? '✓' : '✗'}</span>
                    <span class="criteria-label">Has manifest</span>
                    ${folder.has_manifest ? `<button class="btn" data-book-id="${folder.book_id}" style="margin-left: 10px; padding: 4px 8px; font-size: 11px; background: #0e639c; cursor: pointer;">View</button>` : ''}
                </div>
                <div class="criteria-item" style="grid-column: 1 / -1;">
                    <div style="margin-bottom: 8px;">
                        <span class="criteria-icon ${folder.artifacts_count === 5 ? 'check-yes' : 'check-no'}">${folder.artifacts_count === 5 ? '✓' : '✗'}</span>
                        <span class="criteria-label">All artifacts (${folder.artifacts_count}/5)</span>
                    </div>
                    <div style="margin-left: 32px; display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 12px;">
                        ${['toc_discovery.json', 'toc_parse.json', 'page_mapping.json', 'verified_songs.json', 'output_files.json'].map(name => {
                            const present = folder.artifacts_list && folder.artifacts_list.includes(name);
                            return `<div style="color: ${present ? '#4ec9b0' : '#858585'};">
                                ${present ? '✓' : '✗'} ${name}
                            </div>`;
                        }).join('')}
                    </div>
                </div>
                <div class="criteria-item">
                    <span class="criteria-icon ${folder.all_files_match ? 'check-yes' : 'check-no'}">${folder.all_files_match ? '✓' : '✗'}</span>
                    <span class="criteria-label">All files match</span>
                </div>
                <div class="criteria-item">
                    <span class="criteria-icon ${folder.most_files_match ? 'check-yes' : 'check-no'}">${folder.most_files_match ? '✓' : '✗'}</span>
                    <span class="criteria-label">Most files match</span>
                </div>
            `;

            // Update folder info
            const folderInfo = document.getElementById('folder-info');
            folderInfo.innerHTML = `
                <div class="info-row">
                    <span class="info-label">Book ID</span>
                    <span class="info-value">${folder.book_id}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Local Path</span>
                    <span class="info-value">${folder.local_path}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">S3 Path</span>
                    <span class="info-value">${folder.s3_path}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Local Songs</span>
                    <span class="info-value">${folder.local_songs}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">S3 Songs</span>
                    <span class="info-value">${folder.s3_songs}</span>
                </div>
            `;

            // Build file comparison table
            buildFileComparisonTable(folder);

            // Add event listener to manifest view button
            const manifestBtn = document.querySelector('.criteria-item button[data-book-id]');
            if (manifestBtn) {
                manifestBtn.onclick = function() {
                    viewManifest(this.getAttribute('data-book-id'));
                };
            }
        }


        async function viewManifest(bookId) {
            try {
                // Find the folder with this book_id in the embedded data
                let manifest = null;
                for (const [tier, folders] of Object.entries(matchDataEmbedded.quality_tiers)) {
                    const folder = folders.find(f => f.book_id === bookId);
                    if (folder && folder.manifest_content) {
                        manifest = folder.manifest_content;
                        break;
                    }
                }

                if (!manifest) throw new Error('Manifest not found in embedded data');

                const manifestJson = JSON.stringify(manifest, null, 2);
                const popup = window.open('', 'Manifest Viewer', 'width=900,height=700');
                popup.document.write(`
                    <html>
                    <head>
                        <title>Manifest - ${bookId}</title>
                        <style>
                            body { 
                                font-family: 'Consolas', 'Monaco', monospace; 
                                background: #1e1e1e; 
                                color: #d4d4d4; 
                                padding: 20px;
                                margin: 0;
                            }
                            h2 { color: #569cd6; margin-top: 0; }
                            pre { 
                                white-space: pre-wrap; 
                                word-wrap: break-word;
                                background: #252526;
                                padding: 15px;
                                border-radius: 4px;
                                border-left: 3px solid #569cd6;
                            }
                        </style>
                    </head>
                    <body>
                        <h2>Manifest for ${bookId}</h2>
                        <pre>${manifestJson.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                    </body>
                    </html>
                `);
            } catch (error) {
                alert('Error loading manifest: ' + error.message);
            }
        }

        function buildFileComparisonTable(folder) {
            const fc = folder.file_comparison;
            const fileComparison = document.getElementById('file-comparison');

            // Extract folder artist for filename normalization
            const folderArtist = extractFolderArtist(folder.local_path);

            // Get all unique filenames
            const allFiles = new Set([
                ...Object.keys(fc.local_only_files || []).map(() => null),
                ...Object.keys(fc.s3_only_files || []).map(() => null)
            ]);

            // Build a map of file statuses
            const fileMap = {};

            // Add local-only files
            (fc.local_only_files || []).forEach(item => {
                // Handle both old format (string) and new format (object with filename and size)
                const filename = typeof item === 'string' ? item : item.filename;
                const filesize = typeof item === 'string' ? null : item.size;

                const normalizedName = normalizeFilename(filename, folderArtist);
                fileMap[filename] = {
                    local: filename,
                    localSize: filesize,
                    s3: null,
                    s3Size: null,
                    status: 'local-only',
                    normalizedLocal: normalizedName,
                    needsRenameLocal: shouldNormalizeFilename(filename, normalizedName)
                };
            });

            // Add S3-only files
            (fc.s3_only_files || []).forEach(item => {
                // Handle both old format (string) and new format (object with filename and size)
                const filename = typeof item === 'string' ? item : item.filename;
                const filesize = typeof item === 'string' ? null : item.size;

                const normalizedName = normalizeFilename(filename, folderArtist);
                fileMap[filename] = {
                    local: null,
                    localSize: null,
                    s3: filename,
                    s3Size: filesize,
                    status: 's3-only',
                    normalizedS3: normalizedName,
                    needsRenameS3: shouldNormalizeFilename(filename, normalizedName)
                };
            });

            // Add size mismatches
            (fc.size_mismatches || []).forEach(mismatch => {
                const normalizedName = normalizeFilename(mismatch.filename, folderArtist);
                fileMap[mismatch.filename] = {
                    local: mismatch.filename,
                    localSize: mismatch.local_size || null,
                    s3: mismatch.filename,
                    s3Size: mismatch.s3_size || null,
                    status: 'size-mismatch',
                    normalizedLocal: normalizedName,
                    normalizedS3: normalizedName,
                    needsRenameLocal: shouldNormalizeFilename(mismatch.filename, normalizedName),
                    needsRenameS3: shouldNormalizeFilename(mismatch.filename, normalizedName)
                };
            });

            const folderDecisions = decisions[folder.local_path]?.fileDecisions || {};

            let html = `
                <div style="margin-bottom: 10px; color: #858585; font-size: 13px;">
                    Local files: ${fc.total_local} | S3 files: ${fc.total_s3} | Matching (name+size): ${fc.matching_files}/${fc.matching_names} | Size mismatches: ${fc.size_mismatches?.length || 0}
                </div>
            `;

            // Count files that need renaming
            const needsRenameCount = Object.values(fileMap).filter(f => f.needsRenameLocal || f.needsRenameS3).length;

            // Count files that need copying
            const needsCopyToS3Count = Object.values(fileMap).filter(f => f.status === 'local-only').length;
            const needsCopyToLocalCount = Object.values(fileMap).filter(f => f.status === 's3-only').length;

            // Build bulk action buttons
            const bulkButtons = [];

            if (needsRenameCount > 0) {
                bulkButtons.push(`
                    <button class="btn" onclick="acceptAllRenames('${folder.local_path}')"
                            style="background: #4ec9b0; color: #000; padding: 6px 12px; font-weight: bold;">
                        ✓ Accept All ${needsRenameCount} Rename${needsRenameCount > 1 ? 's' : ''}
                    </button>
                `);
            }

            if (needsCopyToS3Count > 0) {
                bulkButtons.push(`
                    <button class="btn" onclick="copyAllToS3('${folder.local_path}')"
                            style="background: #0e639c; color: white; padding: 6px 12px; font-weight: bold; margin-left: 10px;">
                        → Copy All ${needsCopyToS3Count} to S3
                    </button>
                `);
            }

            if (needsCopyToLocalCount > 0) {
                bulkButtons.push(`
                    <button class="btn" onclick="copyAllToLocal('${folder.local_path}')"
                            style="background: #c586c0; color: white; padding: 6px 12px; font-weight: bold; margin-left: 10px;">
                        ← Copy All ${needsCopyToLocalCount} to Local
                    </button>
                `);
            }

            if (bulkButtons.length > 0) {
                html += `
                    <div style="margin-bottom: 10px;">
                        ${bulkButtons.join('')}
                    </div>
                `;
            }

            if (Object.keys(fileMap).length > 0) {
                html += `
                    <table class="file-comparison-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Local</th>
                                <th style="width: 40%;">S3</th>
                                <th style="width: 20%;">Your Choice</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (const [key, fileInfo] of Object.entries(fileMap)) {
                    const savedDecision = folderDecisions[key] || {};
                    const action = savedDecision.action || '';

                    // Build action buttons based on file status
                    let actionButtons = '';

                    if (fileInfo.status === 'local-only') {
                        actionButtons = `
                            <button class="action-btn action-btn-copy-to-s3 ${action === 'copy-to-s3' ? 'selected' : ''}"
                                    onclick="setFileAction('${escapeJsString(encodeURIComponent(key))}', 'copy-to-s3', '${fileInfo.status}', '${escapeJsString(encodeURIComponent(fileInfo.local || ""))}')">
                                → Copy to S3
                            </button>
                            ${fileInfo.needsRenameLocal ? `
                                <button class="action-btn action-btn-copy-to-local ${action === 'rename-local' ? 'selected' : ''}"
                                        onclick="setFileRename('${escapeJsString(encodeURIComponent(key))}', '${escapeJsString(encodeURIComponent(fileInfo.normalizedLocal || ""))}', 'local')"
                                        title="Rename to: ${escapeJsString(fileInfo.normalizedLocal)}">
                                    ✏️ Rename
                                </button>
                            ` : ''}
                            <button class="action-btn action-btn-delete ${action === 'delete-local' ? 'selected' : ''}"
                                    onclick="setFileAction('${escapeJsString(encodeURIComponent(key))}', 'delete-local', '${fileInfo.status}', '${escapeJsString(encodeURIComponent(fileInfo.local || ""))}')">
                                🗑 Delete from Local
                            </button>
                        `;
                    } else if (fileInfo.status === 's3-only') {
                        actionButtons = `
                            <button class="action-btn action-btn-copy-to-local ${action === 'copy-to-local' ? 'selected' : ''}"
                                    onclick="setFileAction('${escapeJsString(encodeURIComponent(key))}', 'copy-to-local', '${fileInfo.status}', '${escapeJsString(encodeURIComponent(fileInfo.s3 || ""))}')">
                                ← Copy to Local
                            </button>
                            ${fileInfo.needsRenameS3 ? `
                                <button class="action-btn action-btn-copy-to-s3 ${action === 'rename-s3' ? 'selected' : ''}"
                                        onclick="setFileRename('${escapeJsString(encodeURIComponent(key))}', '${escapeJsString(encodeURIComponent(fileInfo.normalizedS3 || ""))}', 's3')"
                                        title="Rename to: ${fileInfo.normalizedS3}">
                                    ✏️ Rename
                                </button>
                            ` : ''}
                            <button class="action-btn action-btn-delete ${action === 'delete-s3' ? 'selected' : ''}"
                                    onclick="setFileAction('${escapeJsString(encodeURIComponent(key))}', 'delete-s3', '${fileInfo.status}', '${escapeJsString(encodeURIComponent(fileInfo.s3 || ""))}')">
                                🗑 Delete from S3
                            </button>
                        `;
                    } else if (fileInfo.status === 'size-mismatch') {
                        actionButtons = `
                            <button class="action-btn action-btn-copy-to-s3 ${action === 'copy-local-to-s3' ? 'selected' : ''}"
                                    onclick="setFileAction('${escapeJsString(encodeURIComponent(key))}', 'copy-local-to-s3', '${fileInfo.status}', '${escapeJsString(encodeURIComponent(fileInfo.local || ""))}')">
                                Local → S3
                            </button>
                            <button class="action-btn action-btn-copy-to-local ${action === 'copy-s3-to-local' ? 'selected' : ''}"
                                    onclick="setFileAction('${escapeJsString(encodeURIComponent(key))}', 'copy-s3-to-local', '${fileInfo.status}', '${escapeJsString(encodeURIComponent(fileInfo.s3 || ""))}')">
                                S3 → Local
                            </button>
                            ${fileInfo.needsRenameLocal || fileInfo.needsRenameS3 ? `
                                <button class="action-btn action-btn-copy-to-local ${action === 'rename-local' ? 'selected' : ''}"
                                        onclick="setFileRename('${escapeJsString(encodeURIComponent(key))}', '${escapeJsString(encodeURIComponent(fileInfo.normalizedLocal || ""))}', 'local')"
                                        title="Rename Local to: ${escapeJsString(fileInfo.normalizedLocal)}">
                                    ✏️ Rename Local
                                </button>
                                <button class="action-btn action-btn-copy-to-s3 ${action === 'rename-s3' ? 'selected' : ''}"
                                        onclick="setFileRename('${escapeJsString(encodeURIComponent(key))}', '${escapeJsString(encodeURIComponent(fileInfo.normalizedS3 || ""))}', 's3')"
                                        title="Rename S3 to: ${escapeJsString(fileInfo.normalizedS3)}">
                                    ✏️ Rename S3
                                </button>
                            ` : ''}
                            <button class="action-btn action-btn-delete ${action === 'delete-local' ? 'selected' : ''}"
                                    onclick="setFileAction('${escapeJsString(encodeURIComponent(key))}', 'delete-local', '${fileInfo.status}', '${escapeJsString(encodeURIComponent(fileInfo.local || ""))}')">
                                🗑 Local
                            </button>
                            <button class="action-btn action-btn-delete ${action === 'delete-s3' ? 'selected' : ''}"
                                    onclick="setFileAction('${escapeJsString(encodeURIComponent(key))}', 'delete-s3', '${fileInfo.status}', '${escapeJsString(encodeURIComponent(fileInfo.s3 || ""))}')">
                                🗑 S3
                            </button>
                            <button class="action-btn action-btn-delete-both ${action === 'delete-both' ? 'selected' : ''}"
                                    onclick="setFileAction('${escapeJsString(encodeURIComponent(key))}', 'delete-both', '${fileInfo.status}', '${escapeJsString(encodeURIComponent(fileInfo.local || ""))}')">
                                🗑 Both
                            </button>
                        `;
                    }

                    // Build rename hints
                    let renameHint = '';
                    if (fileInfo.needsRenameLocal && fileInfo.local) {
                        renameHint += `<div style="margin-top: 5px; font-size: 11px; color: #dcdcaa;">→ ${fileInfo.normalizedLocal}</div>`;
                    }
                    if (fileInfo.needsRenameS3 && fileInfo.s3) {
                        renameHint += `<div style="margin-top: 5px; font-size: 11px; color: #dcdcaa;">→ ${fileInfo.normalizedS3}</div>`;
                    }

                    html += `
                        <tr>
                            <td class="file-name">
                                ${fileInfo.local || '<em style="color: #858585;">Not in local</em>'}
                                ${fileInfo.localSize ? `<div style="font-size: 10px; color: #858585; margin-top: 3px;">${formatFileSize(fileInfo.localSize)}</div>` : ''}
                                ${fileInfo.needsRenameLocal && fileInfo.local ? `<div style="font-size: 10px; color: #dcdcaa; margin-top: 3px;">→ ${fileInfo.normalizedLocal}</div>` : ''}
                            </td>
                            <td class="file-name">
                                ${fileInfo.s3 || '<em style="color: #858585;">Not in S3</em>'}
                                ${fileInfo.s3Size ? `<div style="font-size: 10px; color: #858585; margin-top: 3px;">${formatFileSize(fileInfo.s3Size)}</div>` : ''}
                                ${fileInfo.needsRenameS3 && fileInfo.s3 ? `<div style="font-size: 10px; color: #dcdcaa; margin-top: 3px;">→ ${fileInfo.normalizedS3}</div>` : ''}
                            </td>
                            <td>
                                <div style="margin-bottom: 5px;">
                                    <span class="file-status status-${fileInfo.status}">${fileInfo.status.replace(/-/g, ' ')}</span>
                                </div>
                                <div class="action-buttons-list">
                                    ${actionButtons}
                                </div>
                                ${savedDecision.action ? `<div style="margin-top: 5px; font-size: 11px; color: #4ec9b0;">✓ ${savedDecision.action.replace(/-/g, ' ')}${savedDecision.normalized_name ? ': ' + savedDecision.normalized_name : ''}</div>` : ''}
                            </td>
                        </tr>
                    `;
                }

                html += `
                        </tbody>
                    </table>
                `;
            } else {
                html += '<div style="padding: 20px; text-align: center; color: #4ec9b0;">✓ No file differences detected</div>';
            }

            fileComparison.innerHTML = html;
        }
    
        // Completion tracking with localStorage
        // decisions already declared earlier in the file

        function saveDecisions() {
            localStorage.setItem('songbook_reconciliation_decisions', JSON.stringify(decisions));
        }

        function toggleComplete(folderPath) {
            if (!decisions[folderPath]) {
                decisions[folderPath] = {};
            }
            decisions[folderPath].completed = !decisions[folderPath].completed;
            saveDecisions();
            initializeViewer(); // Refresh display
        }

        function markAllPerfectAsComplete() {
            if (!confirm('Mark all PERFECT matches as completed?')) {
                return;
            }

            let count = 0;
            console.log('matchData:', matchData);
            console.log('quality_tiers:', matchData?.quality_tiers);
            console.log('perfect folders:', matchData?.quality_tiers?.perfect?.length);
            if (matchData && matchData.quality_tiers) {
                const perfectFolders = matchData.quality_tiers.perfect || [];
                console.log('perfectFolders:', perfectFolders.length);
                let alreadyCompleted = 0;
                perfectFolders.forEach(folder => {
                    if (!decisions[folder.local_path]) {
                        decisions[folder.local_path] = {};
                    }
                    if (!decisions[folder.local_path].completed) {
                        decisions[folder.local_path].completed = true;
                        count++;
                    } else {
                        alreadyCompleted++;
                    }
                });
                console.log('Already completed:', alreadyCompleted);
                console.log('Newly marked:', count);
            }

            saveDecisions();
            initializeViewer();
            alert(`Marked ${count} folders as completed`);
        }



    </script>
</body>
</html>
